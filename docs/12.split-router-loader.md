---
sidebar_position: 12
---


# 12. 冷启动提速 split-router-loader

### 简介
`split-router-loader` 实现原理主要是基于对 `umi` 的`配置式路由文件`在 webpack 开发模式下文件 `loader` 阶段动态生成，以实现按需加载。

### 用法
1. 引入 `split-router-loader` 代码  

飞搭工程的 `config/config.dev.ts` 引入 `split-router-loader` 代码。

```ts
import { IConfig } from 'umi';
import path from "path"; // ref: https://umijs.org/config/

const config: IConfig = {
  define: {
  // ......
  chainWebpack: (c) => {
    c.module
      .rule('split-router-loader')
      .test(/\.tsx?$/)
      .use('split-router-loader')
      .loader(
        path.join(__dirname,
          '../scripts/loaders/split-router-loader.js'
        )
      )
      .end();
    return c;
  },
};

export default config;

```
2. 定义需要拆分的路由  

修改飞搭工程的 `scripts/loaders/router.js` 文件，以 `{key:string: values:string[]}` 形式维护需要拆分的路由。  
例：
```ts
const routerModeMap = {
  script: [
    '/hmde/script-event', // 路由对应的 path（仅识别第一层）
    '/hmde/script-execution-log',
    '/hmde/script-utility',
    '/hmde/preset-function-config'
  ],
  role: [
    '/hlod/role-permission-query'
  ]
}

module.exports = {
  routerModeMap,
}
```

3. 定义新的 start 启动项  

修改飞搭工程的 `packages/你的子模块/package.json` 文件，`复制原有的 start 启动脚本`，添加变量 `SPILT_ROUTER=你添加的routerModeMap中的 key 值`。  
例：  
SPILT_ROUTER=script
```bash    
"start-script": "cross-env UMI_ENV=dev SPILT_ROUTER=script NODE_OPTIONS=--max-old-space-size=4096 node ../../node_modules/umi/bin/umi.js dev",
```
如果想同时启动多个拆分路由,可以用逗号拼接  
例：  
SPILT_ROUTER=script,role
```bash    
"start-script-role": "cross-env UMI_ENV=dev SPILT_ROUTER=script,role NODE_OPTIONS=--max-old-space-size=4096 node ../../node_modules/umi/bin/umi.js dev",
```

#### **FAQ**

**1. 为什么切换 start 启动项的时候还是之前的路由**  
因为项目开启了 webpack 5 物理缓存功能，默认配置文件（包括路由）没变化，不会再重新编译。  
`split-router-loader` 没有对原路由文件进行修改，修改过程发生在 webpack 编译流程中文件 loader 阶段，因此源文件不会有任何变化，导致复用了缓存。  
可通过清除 `.umi/.cache` 文件夹清除缓存。  
也可执行以下脚本：

```bash
  "rm-start-cache": "rm -rf ./src/.umi/.cache"
```

<maintainer authors={["hzm"]}/>

