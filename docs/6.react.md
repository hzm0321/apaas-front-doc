---
sidebar_position: 6
---

# 6. React

### 6.1. æ¦‚è¿°

ç›®å‰ï¼Œ`TypeScript` å·²ç»åœ¨ `React` ä¸Šå¾—åˆ°äº†è‰¯å¥½çš„æ”¯æŒã€‚é¡¹ç›®ä¸Šç›®å‰é‡‡ç”¨ `React 16` ç‰ˆæœ¬ç”¨åšå¼€å‘ã€‚æ­¤è§„èŒƒä¼šå®šä¹‰ä¸€äº›æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨
React API æ‰€éœ€æ³¨å…¥çš„ç±»å‹ã€‚

### 6.2. ç»„ä»¶ç±»å‹

#### 6.2.1. å‡½æ•°ç»„ä»¶

<intro type="must" />  

å‡½æ•°ç»„ä»¶é‡‡ç”¨ `React.FC` ç±»å‹è¿›è¡Œç±»å‹å®šä¹‰ã€‚

```tsx
interface Props {
  message: string;
}

const App: React.FC<Props> = ({message, children}) => (
  <div>{message}{children}</div>
);
```

:::info

`React.FC` ä¸ä»…æ ¡éªŒç»„ä»¶å‚æ•°ç±»å‹å’Œè¿”å›çš„ `ReactElement`ï¼Œä»–åŒæ—¶åˆæ ¡éªŒäº† `displayName`ã€`propTypes`ã€`defaultProps`
ã€`contextTypes` å±æ€§ç±»å‹ã€‚

:::

#### 6.2.2. è·¯ç”±ç»„ä»¶

<intro type="must" /> 

ä¸åŒé¡¹ç›®å®‰è£…äº†ä¸åŒçš„ `react-router` ç‰ˆæœ¬ï¼Œä¸»è¦æœ‰ v4 å’Œ v5 ä¸¤å¤§ç‰ˆæœ¬ã€‚é’ˆå¯¹ä¸åŒç‰ˆæœ¬æ¨èé‡‡ç”¨ä¸åŒçš„æ–¹å¼è¿›è¡Œè·¯ç”±å‚æ•°çš„ä½¿ç”¨ã€‚

**react-router v4**

éé¡¶å±‚ç»„ä»¶éœ€è¦é€šè¿‡é«˜é˜¶ç»„ä»¶çš„æ–¹å¼ï¼Œä½¿ç”¨ `withRouter` åŒ…è£…ç»„ä»¶æ¥è·å–è·¯ç”±å‚æ•°ã€‚
é‚£ä¹ˆé¡¶å±‚ç»„ä»¶æˆ–è·¯ç”±åŒ…è£…ç»„ä»¶çš„ç±»å‹å®šä¹‰å°±åº”å½“ä» `react-router` ä¸Šçš„ `RouteComponentProps` ç»§æ‰¿ã€‚

```tsx
import {RouteComponentProps} from 'react-router';

interface Props extends RouteComponentProps {
  message: string;
}

const App: React.FC<Props> = ({message, children, history}) => (
  <div>{message}{children}</div>
);
```

å¦‚æœè·¯ç”±ç»„ä»¶æ¥æ”¶è·¯ç”±å‚æ•°ï¼Œå¯ä»¥é€šè¿‡ `RouteComponentProps` æä¾›çš„æ³›å‹å‚æ•°æ³¨å…¥è·¯ç”±å‚æ•°ç±»å‹ã€‚`RouteComponentProps` å…è®¸æ¥æ”¶3ä¸ªæ³›å‹å‚æ•°ã€‚

- ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è·¯ç”± `params` å‚æ•°çš„ç±»å‹ã€‚
- ç¬¬äºŒä¸ªå‚æ•°æ˜¯è·¯ç”± `statusCode` å‚æ•°ï¼Œè¡¨ç¤ºå½“å‰è·¯ç”±çŠ¶æ€ç¼–ç æ˜¯ 404ã€500 è¿˜æ˜¯å…¶ä»–ã€‚
- ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è·¯ç”± `state` å‚æ•°çš„ç±»å‹ã€‚

```tsx
import {RouteComponentProps, StaticContext, withRouter} from 'react-router';

interface Props extends RouteComponentProps<{
  id: string;
  type: string;
},
  StaticContext,
  {
    readonly: boolean;
  }> {
  message: string;
}

const App: React.FC<Props> = ({
                                history,
                                match: {params: {id, type}},
                                location: {state: routeState},
                                message,
                                children,
                              }) => (
  <div>{message}{children}</div>
);

export default withRouter(App);
```

**react-router v5ï¼ˆæ¨èï¼‰**

ä»»æ„ç»„ä»¶å¯ä»¥é‡‡ç”¨ `react-route` æä¾›çš„ hooks è·å–è·¯ç”±å‚æ•°ä¿¡æ¯ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ª hooksï¼š

- **useHistory**: è®¿é—® history å¯¹è±¡ï¼Œè¿›è¡Œç¼–ç¨‹å¼å¯¼èˆªï¼ˆå¦‚ push æˆ– replace è·¯ç”±ï¼‰ã€‚
- **useLocation**: è¿”å›å½“å‰çš„ location å¯¹è±¡ï¼Œè¡¨ç¤ºåº”ç”¨çš„å½“å‰ä½ç½®ï¼Œé€šå¸¸ç”¨äºè·å–å½“å‰ URLã€è·¯å¾„åã€çŠ¶æ€ç­‰ä¿¡æ¯ã€‚
- **useParams**: è·å–å½“å‰è·¯ç”±çš„ URL å‚æ•°ï¼Œå¸¸ç”¨äºä» URL ä¸­æå–åŠ¨æ€å€¼ã€‚
- **useRouteMatch**: åŒ¹é…å½“å‰ URL ä¸æŸä¸ªç‰¹å®šè·¯å¾„ï¼Œç±»ä¼¼äº v5 ä¸­çš„ match å¯¹è±¡ï¼Œå¯ä»¥ç”¨äºè‡ªå®šä¹‰è·¯å¾„åŒ¹é…ã€‚

```tsx
import {useHistory, useLocation, useParams, useRouteMatch} from 'react-router';

interface Props {
}

const App: React.FC<Props> = () => {
  const history = useHistory();
  const {id: scriptId, type: viewType} = useParams<{ id: string; type: string }>();
  const {state: routeState = {readonly: false}} = useLocation<{ readonly: boolean }>();
  const match = useRouteMatch<{ id: string; type: string }>();
  
  function handleClick() {
    history.push("/home");
  }

  return (
    <button type="button" onClick={handleClick}>
      Go home
    </button>
  );
};
```
å› ä¸º `useLocation` æ²¡æœ‰æš´éœ²å‡º `query` çš„å‚æ•°ç±»å‹ï¼Œå› æ­¤åœ¨ apaas åŒ…ä¸­å®šä¹‰äº†ä¸€ä¸ª `useSearchParams` çš„ hookï¼Œç”¨äºè·å– query å‚æ•°ã€‚
```ts
import useSearchParams from 'hzero-front-apaas/lib/hooks/useSearchParams';

interface Props {
}

const App: React.FC<Props> = () => {
  const {id} = useSearchParams<{id: string}>();

  return id
};

```

:::tip

ä½¿ç”¨ react-route æä¾›çš„ hooks æ—¶ï¼Œå¯¹äºéœ€è¦æ³›å‹çš„ hook å°½é‡å†™æ˜ç±»å‹

:::

### 6.3. Hooks ç±»å‹

#### 6.3.1. `useState`

<intro type="optional" />  

useState æ¥æ”¶ä¸€ä¸ªæ³›å‹æŒ‡å®šå…¶ä¼ å…¥çš„æ•°æ®ç±»å‹ï¼Œå¦‚æœä¸ä¼ å…¥åˆ™ `TypeScript` æ ¹æ®åˆå§‹å€¼è¿›è¡Œç±»å‹æ¨æ–­ã€‚

```tsx
const [user, setUser] = useState<string>('å¼ ä¸‰');
```

<intro type="must" />  

å¦‚æœè¦ç»™ `useState` åˆå§‹å€¼è®¾ç½®ä¸€ä¸ªç©ºå€¼ï¼Œå¯ä»¥æŠŠç©ºå€¼æ·»åŠ åˆ°æ³›å‹ä¸­ï¼Œæˆ–è€…åœ¨ `useState` å‡½æ•°ä¸­ç›´æ¥è®¾ç½®åˆå§‹å€¼ï¼Œç¦æ­¢ä½¿ç”¨ `as`
è¦†ç›–åˆå§‹å€¼ç±»å‹ã€‚

```tsx
const [user, setUser] = useState<User | null>(null);
```

#### 6.3.2. `useEffect/useLayoutEffect`

<intro type="must" />  

`useEffect` å’Œ `useLayoutEffect` éƒ½ç”¨äºæ‰§è¡Œå‰¯ä½œç”¨ï¼Œå¹¶`è¿”å›ä¸€ä¸ªå¯é€‰çš„æ¸…ç†å‡½æ•°`
ï¼Œè¿™æ„å‘³ç€å¦‚æœå®ƒä»¬ä¸å¤„ç†è¿”å›å€¼ï¼Œå°±ä¸éœ€è¦ç±»å‹ã€‚å½“ä½¿ç”¨ `useEffect`
æ—¶ï¼Œæ³¨æ„ä¸è¦è¿”å›é `function` æˆ– `undefined` çš„å†…å®¹ã€‚

```tsx
// ä¸è¦è¿™æ ·åš
const DelayedEffect: React.FC<{ timerMs: number }> = ({timerMs}) => {
  const {timerMs} = props;

  useEffect(
    () =>
      setTimeout(() => {
        /* do stuff */
      }, timerMs),
    [timerMs]
  );
  return null;
}
```

```tsx
// åº”å½“è¿™æ ·åš
const DelayedEffect: React.FC<{ timerMs: number }> = ({timerMs}) => {
  const {timerMs} = props;

  useEffect(() => {
    setTimeout(() => {
      /* do stuff */
    }, timerMs);
  }, [timerMs]);
  return null;
}
```

#### 6.3.3. `useMemo/useCallback`

<intro type="optional" />   

`useMemo` å’Œ `useCallback` éƒ½å¯é€‰æ¥æ”¶ä¸€ä¸ªæ³›å‹ï¼Œç”¨äºæŒ‡å®šè¿”å›å€¼ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåˆ™é€šè¿‡ç±»å‹æ¨æ–­ã€‚

```tsx
const App: React.FC<{}> = () => {

  const randomNum = useMemo<number>(() => {
    return Math.random();
  }, [])

  return <div>{randomNum}</div>
};
```

#### 6.3.4. `useRef`

<intro type="should" />  

`useRef` è¿”å›äº†ä¸€ä¸ªå¼•ç”¨ï¼Œè¯¥å¼•ç”¨ç±»å‹å¯ä»¥æ˜¯`åªè¯»`æˆ–`å¯ä¿®æ”¹`ï¼Œåº”åœ¨ `useRef` æ˜¾å¼æŒ‡å®šæ³›å‹ï¼Œå°½é‡å‡å°‘ä½¿ç”¨ `any`ã€‚

```tsx
const numberRef = useRef<number>(0);
```

:::tip

å¦‚æœéœ€è¦ `useRef` çš„ç±»å‹`å¯ä¿®æ”¹`ï¼Œå°±éœ€è¦åœ¨æ³›å‹å‚æ•°ä¸­åŒ…å« `| null`

:::

<intro type="should" /> 

å¦‚æœ `useRef` ç»‘å®šçš„æ˜¯ `DOM` å…ƒç´ ï¼Œé‚£ä¹ˆå°±éœ€è¦æä¾›å…ƒç´ ç±»å‹ä½œä¸ºå‚æ•°ï¼Œå¹¶ä½¿ç”¨ `null` ä½œä¸ºåˆå§‹å€¼ã€‚

```tsx
interface Props {
}

const App: React.FC<Props> = ({children}) => {
  const divRef = useRef<HTMLDivElement>(null);

  return <div ref={divRef}>{children}</div>
};
```

<intro type="should" /> 

å¯¹äºå·²çŸ¥å…ƒç´ çš„æ ‡ç­¾ï¼Œå¿…é¡»ä½¿ç”¨å¯¹åº”æ ‡ç­¾çš„ HTMLElement ç±»å‹ï¼Œä¾‹å¦‚ `div` å¯¹åº” `HTMLDivElement`ï¼Œ `input` å¯¹åº” `HTMLInputElement`
ã€‚ä¸åº”å½“ä½¿ç”¨ `HTMLElement`ã€‚

#### 6.3.5. `useImperativeHandle`

<intro type="should" /> 

`useImperativeHandle` åº”å½“æ­é… `forwardRef` è¿›è¡Œä½¿ç”¨ã€‚`forwardRef` éœ€é€šè¿‡æ³›å‹å®šä¹‰åˆ†åˆ«æŒ‡å®š `ref` å’Œ ç»„ä»¶ `props` ç±»å‹ã€‚

```tsx
interface RefProps {
  getName: () => string;
}

interface Props {
  message: string;
}

const App = forwardRef<RefProps, Props>(({message, children}, ref) => {

  useImperativeHandle(ref, () => ({
    getName() {
      return 'hello';
    },
  }));

  return <div>{message}{children}</div>
});

const Use: React.FC<{}> = () => {
  const appRef = useRef<RefProps>(null)
  return <App message="hello" ref={appRef} />
}
```

#### 6.3.6. `useContext`

<intro type="should" /> 

`useContext` éœ€è¦æ­é… `createContext` è¿›è¡Œä½¿ç”¨ã€‚`createContext` åœ¨åˆ›å»ºçš„æ—¶å€™å…è®¸æ¥æ”¶ä¸€ä¸ªæ³›å‹ç”¨äºæŒ‡å®šè¿”å›çš„ä¸Šä¸‹æ–‡ç±»å‹ã€‚

```tsx
import {createContext} from "react";

interface AppContextInterface {
  name: string;
  author: string;
  url: string;
}

const AppCtx = createContext<AppContextInterface | null>(null);

// Provider in your app
const sampleAppContext: AppContextInterface = {
  name: "Using React Context in a Typescript App",
  author: "thehappybug",
  url: "http://www.example.com",
};

export const App = () => (
  <AppCtx.Provider value={sampleAppContext}>...</AppCtx.Provider>
);

// Consume in your app
import {useContext} from "react";

export const PostInfo: React.FC<{}> = () => {
  const appContext = useContext(AppCtx);
  return (
    <div>
      Name: {appContext.name}, Author: {appContext.author}, Url:{" "}
      {appContext.url}
    </div>
  );
};
```

#### 6.3.7. `useSafeState`(ahooks)
`useSafeState` ä¸»è¦ç”¨äºåœ¨ç»„ä»¶å¸è½½åå¼‚æ­¥å›è°ƒå†…çš„ `setState` ä¸å†æ‰§è¡Œï¼Œé¿å…å› ç»„ä»¶å¸è½½åæ›´æ–°çŠ¶æ€è€Œå¯¼è‡´çš„å†…å­˜æ³„æ¼ã€‚  
<intro type="should" />

å¯¹äºæ¥å£è¯·æ±‚åéœ€è¦å¼‚æ­¥æ›´æ–°çŠ¶æ€çš„åœºæ™¯ï¼Œæ¨èä½¿ç”¨ `useSafeState`ã€‚

```tsx
import React, { useEffect } from 'react';
import { useSafeState } from 'ahooks';

const Child = () => {
  // This will right
  const [value, setValue] = useSafeState<string>();

  useEffect(() => {
    setTimeout(() => {
      setValue('data loaded from server');
    }, 5000);
  }, []);

  const text = value || 'Loading...';

  return <div>{text}</div>;
};
```

#### 6.3.10. `è‡ªå®šä¹‰ hooks`

å¦‚æœåœ¨`è‡ªå®šä¹‰ hooks` ä¸­è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œ`TypeScript` ä¼šæ¨æ–­å‡ºä¸€ä¸ªè”åˆç±»å‹è€Œä¸æ˜¯å…ƒç»„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `as const`
ï¼ŒæŠŠè¿”å›çš„æ•°ç»„æŒ‡å®šæˆå…ƒç»„ç±»å‹ã€‚

```ts
import {useState} from "react";

export function useLoading() {
  const [isLoading, setState] = useState(false);
  const load = (aPromise: Promise<any>) => {
    setState(true);
    return aPromise.finally(() => setState(false));
  };
  return [isLoading, load] as const; // ä½¿ç”¨ [boolean, typeof load] ä»£æ›¿ (boolean | typeof load)[]
}
```

### 6.4. è¡¨å•äº‹ä»¶

<intro type="should" />

é’ˆå¯¹è¡¨å•ç±»å‹ï¼ŒReact åŒæ ·æä¾›äº†ä¸°å¯Œçš„ç±»å‹ã€‚åœ¨ä½¿ç”¨ input ç­‰è¿™ç±»è¡¨å•å…ƒç´ æ—¶ï¼Œéœ€è¦æŒ‡å®šä¾‹å¦‚ `onChange` ç­‰äº‹ä»¶ç±»å‹ï¼ˆ IDE
å·¥å…·ä¹Ÿä¼šç»™å‡ºç±»å‹æç¤ºï¼‰ã€‚

```tsx
interface Props {
}

const App: React.FC<Props> = ({children}) => {
  const [text, setText] = useState<string>("");

  // This will right
  const onChange = useCallback((e: React.FormEvent<HTMLInputElement>) => {
    setText(e.currentTarget.value);
  }, []);

  return (
    <div>
      <input type="text" value={text} onChange={onChange} />
    </div>
  );
};
```

åœ¨ React ä¸­ï¼Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå°±æ˜¯ï¼š`åˆæˆäº‹ä»¶`ã€‚ä»–æ˜¯åŸºäº `Virtual DOM` æ‰€å®ç°çš„ä¸€å¥—äº‹ä»¶ç³»ç»Ÿã€‚æˆ‘ä»¬åœ¨ `React Element`
ä¸­æ‰€å®šä¹‰çš„äº‹ä»¶ï¼Œä¼šä½œä¸ºåˆæˆäº‹ä»¶æ¥å¤„ç†ï¼Œå…¶å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œä¼šæ¥æ”¶åˆ°ä¸€ä¸ª `SyntheticEvent` çš„å®ä¾‹ã€‚

<details>
  <summary>åˆæˆäº‹ä»¶æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ</summary>
<div>

1. æŠ¹å¹³å„æµè§ˆå™¨ä¹‹é—´çš„äº‹ä»¶å·®å¼‚ï¼Œä¸å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œå¯¹å¼€å‘è€…æä¸ºå‹å¥½ã€‚
2. åˆæˆäº‹ä»¶åˆ©ç”¨å†’æ³¡æœºåˆ¶ï¼Œåœ¨é¡¶å±‚ document å®Œæˆäº‹ä»¶æ³¨å†Œå’Œåˆ†å‘ï¼Œé¿å…ç›´æ¥æ“ä½œ DOM äº‹ä»¶ï¼Œå‡å°‘å†…å­˜å¼€é”€ï¼Œç®€åŒ–äº‹ä»¶å¤„ç†å’Œå›æ”¶æœºåˆ¶ã€‚
3. å†…éƒ¨ä½¿ç”¨äº‹ä»¶æ± çš„æ¦‚å¿µï¼Œç®¡ç†åˆæˆäº‹ä»¶çš„åˆ›å»ºï¼Œå›æ”¶åŠå…¶å¤ç”¨ï¼Œæå‡æ€§èƒ½ã€‚

</div>
</details>

å› æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨åˆæˆäº‹ä»¶ï¼ˆ `SyntheticEvent` ï¼‰ä½œä¸ºé€šç”¨çš„ç±»å‹ï¼Œå»åˆå¹¶ form çš„ `onSubmit` äº‹ä»¶ç±»å‹ã€‚

```tsx
<form
  ref={formRef}
  onSubmit={(e: React.SyntheticEvent) => {
    e.preventDefault();
    const target = e.target as typeof e.target & {
      email: { value: string };
      password: { value: string };
    };
    const email = target.email.value; // typechecks!
    const password = target.password.value; // typechecks!
    // etc...
  }}
>
  <div>
    <label>
      Email:
      <input type="email" name="email" />
    </label>
  </div>
  <div>
    <label>
      Password:
      <input type="password" name="password" />
    </label>
  </div>
  <div>
    <input type="submit" value="Log in" />
  </div>
</form>
```

### 6.5. `cloneElement`

<intro type="should" /> 

`React.cloneElement` å¯ä»¥ç”¨æ¥å¤åˆ¶å…ƒç´ ï¼Œå¹¶ä¸”å¯ä»¥æ·»åŠ æ–°çš„ `props`ã€‚`React.cloneElement`
å…è®¸ä¼ å…¥ä¸€ä¸ªæ³›å‹å‚æ•°ï¼Œç”¨äºæŒ‡å®š `props` ç±»å‹ã€‚

```tsx
import {Button} from "choerodon-ui/pro";
// ...
const btn = <Button />;
React.cloneElement<typeof Button>(btn, {
  color: 'primary',
})
```

### 6.6. ç»„ä»¶å’Œ Hook å¿…é¡»æ˜¯å¹‚ç­‰çš„
<intro type="must" />

ç»„ä»¶å¿…é¡»å§‹ç»ˆæ ¹æ®å…¶è¾“å…¥ï¼ˆpropsã€stateã€å’Œ contextï¼‰è¿”å›ç›¸åŒçš„è¾“å‡ºã€‚è¿™è¢«ç§°ä¸ºâ€œ`å¹‚ç­‰æ€§`â€ã€‚`å¹‚ç­‰æ€§`æ˜¯å‡½æ•°å¼ç¼–ç¨‹ä¸­ç»å¸¸ä½¿ç”¨çš„ä¸€ä¸ªæœ¯è¯­ï¼Œå®ƒæŒ‡çš„æ˜¯åªè¦ä½ ä½¿ç”¨ç›¸åŒçš„è¾“å…¥è¿è¡Œä»£ç ï¼Œå¾—åˆ°çš„ç»“æœæ€»æ˜¯ä¸€æ ·çš„ã€‚

è¿™æ„å‘³ç€ï¼Œä¸ºäº†éµå¾ªè¿™ä¸€è§„åˆ™ï¼Œæ‰€æœ‰åœ¨æ¸²æŸ“æœŸé—´æ‰§è¡Œçš„ä»£ç ä¹Ÿå¿…é¡»æ˜¯å¹‚ç­‰çš„ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è¿™è¡Œä»£ç å°±ä¸æ˜¯å¹‚ç­‰çš„ï¼ˆå› æ­¤ï¼ŒåŒ…å«è¿™è¡Œä»£ç çš„ç»„ä»¶ä¹Ÿä¸æ˜¯å¹‚ç­‰çš„ï¼‰ï¼š
```js
function Clock() {
  // This will error
  const time = new Date(); // ğŸ”´ é”™è¯¯çš„ï¼šæ€»æ˜¯è¿”å›ä¸åŒçš„ç»“æœï¼
  return <span>{time.toLocaleString()}</span>
}
```

å¯ä»¥æŠŠå‰¯ä½œç”¨ä»ç»„ä»¶ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œæ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„è‡ªå®šä¹‰ hook ä¸­ã€‚ä¾‹:  

```js
import { useState, useEffect } from 'react';

function useTime() {
  // 1. è·Ÿè¸ªå½“å‰æ—¥æœŸçš„çŠ¶æ€ã€‚`useState` æ¥å—ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°ä½œä¸ºå…¶
  //    åˆå§‹çŠ¶æ€ã€‚å®ƒåªåœ¨è°ƒç”¨ Hook æ—¶è¿è¡Œä¸€æ¬¡ï¼Œå› æ­¤åªæœ‰è°ƒç”¨ Hook æ—¶çš„
  //    å½“å‰æ—¥æœŸæ‰è¢«é¦–å…ˆè®¾ç½®ã€‚
  const [time, setTime] = useState(() => new Date());

  useEffect(() => {
    // 2. ä½¿ç”¨ `setInterval` æ¯ç§’æ›´æ–°å½“å‰æ—¥æœŸã€‚
    const id = setInterval(() => {
      setTime(new Date()); // âœ… æ­£ç¡®çš„ï¼šéå¹‚ç­‰ä»£ç ä¸å†åœ¨æ¸²æŸ“ä¸­è¿è¡Œã€‚
    }, 1000);
    // 3. è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šå¿˜è®°æ¸…ç† `setInterval` å®šæ—¶å™¨ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚
    return () => clearInterval(id);
  }, []);

  return time;
}

export default function Clock() {
  // This will right
  const time = useTime();
  return <span>{time.toLocaleString()}</span>;
}
```

### 6.7. å‰¯ä½œç”¨å¿…é¡»åœ¨æ¸²æŸ“ä¹‹å¤–æ‰§è¡Œ
å‰¯ä½œç”¨ä¸åº”è¯¥åœ¨æ¸²æŸ“ä¸­æ‰§è¡Œï¼Œå› ä¸º React å¯èƒ½ä¼šå¤šæ¬¡æ¸²æŸ“ç»„ä»¶ä»¥æä¾›æœ€ä½³çš„ç”¨æˆ·ä½“éªŒã€‚
#### 6.7.1. å±€éƒ¨ mutation
<intro type="must" />

ç¦æ­¢ä¿®æ”¹åœ¨ç»„ä»¶å¤–å£°æ˜çš„å˜é‡ã€‚
```js
// This will error
const items = []; // ğŸ”´ é”™è¯¯çš„ï¼šåœ¨ç»„ä»¶å¤–éƒ¨åˆ›å»º
function FriendList({ friends }) {
  for (let i = 0; i < friends.length; i++) {
    const friend = friends[i];
    items.push(
      <Friend key={friend.id} friend={friend} />
    ); // ğŸ”´ é”™è¯¯çš„ï¼šä¿®æ”¹äº†ä¸€ä¸ªåœ¨æ¸²æŸ“ä¹‹å¤–åˆ›å»ºçš„å€¼ã€‚
  }
  return <section>{items}</section>;
}
```
å¯ä»¥åœ¨ç»„ä»¶å†…éƒ¨æ¸²æŸ“å‰è¿›è¡Œä¿®æ”¹ã€‚
```js
function FriendList({ friends }) {
  // This will right
  const items = []; // âœ… æ­£ç¡®çš„ï¼šåœ¨å±€éƒ¨åˆ›å»º
  for (let i = 0; i < friends.length; i++) {
    const friend = friends[i];
    items.push(
      <Friend key={friend.id} friend={friend} />
    ); // âœ… æ­£ç¡®çš„ï¼šå±€éƒ¨ä¿®æ”¹æ˜¯å¯ä»¥çš„ã€‚
  }
  return <section>{items}</section>;
}
```

#### 6.7.2. æ”¹å˜ DOM
<intro type="must" />

åœ¨ React ç»„ä»¶çš„æ¸²æŸ“é€»è¾‘ä¸­ä¸å…è®¸æœ‰ç›´æ¥å¯¹ç”¨æˆ·å¯è§çš„å‰¯ä½œç”¨ã€‚æ¢å¥è¯è¯´ï¼Œä»…ä»…è°ƒç”¨ä¸€ä¸ªç»„ä»¶å‡½æ•°æœ¬èº«ä¸åº”å½“åœ¨å±å¹•ä¸Šäº§ç”Ÿå˜åŒ–ã€‚

```js
function ProductDetailPage({ product }) {
  // This will error
  document.window.title = product.title; // ğŸ”´ é”™è¯¯çš„ï¼šæ”¹å˜ DOM
}
```
å¯ä»¥ä½¿ç”¨ `useEffect`/`useLayoutEffect` å¤„ç†æ¸²æŸ“å¤–å‰¯ä½œç”¨ã€‚

### 6.8. å‚æ•°ä¸å¯å˜æ€§

#### 6.8.1. ä¸è¦ä¿®æ”¹ props
<intro type="must" />

props æ˜¯ä¸å¯å˜çš„ï¼Œå› ä¸ºå¦‚æœä½ æ”¹å˜äº†å®ƒä»¬ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ä¼šäº§ç”Ÿä¸ä¸€è‡´çš„ç»“æœï¼Œè¿™ä¼šè®©è°ƒè¯•å˜å¾—å›°éš¾ï¼Œå› ä¸ºç¨‹åºå¯èƒ½ä¼šåœ¨æŸäº›æƒ…å†µä¸‹å·¥ä½œï¼Œè€Œåœ¨å¦ä¸€äº›æƒ…å†µä¸‹ä¸å·¥ä½œã€‚
```js
function Post({ item }) {
  // This will error
  item.url = new Url(item.url, base); // ğŸ”´ é”™è¯¯çš„ï¼šæ°¸è¿œä¸è¦ç›´æ¥ä¿®æ”¹ props
  return <Link url={item.url}>{item.title}</Link>;
}
```
```js
function Post({ item }) {
  // This will right
  const url = new Url(item.url, base); // âœ… æ­£ç¡®çš„ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‰¯æœ¬æ›¿ä»£
  return <Link url={url}>{item.title}</Link>;
}
```
#### 6.8.2. ä¸è¦ä¿®æ”¹ state
<intro type="must" />

æˆ‘ä»¬ä¸åº”è¯¥ç›´æ¥åœ¨ state å˜é‡ä¸Šè¿›è¡Œæ›´æ–°ï¼Œè€Œåº”è¯¥ä½¿ç”¨ `useState` è¿”å›çš„ setter å‡½æ•°æ¥è¿›è¡Œæ›´æ–°ã€‚å¦‚æœåœ¨ state å˜é‡ä¸Šç›´æ¥ä¿®æ”¹å€¼ï¼Œå¹¶ä¸ä¼šå¯¼è‡´ç»„ä»¶ç•Œé¢æ›´æ–°ï¼Œè¿™æ ·ç”¨æˆ·ç•Œé¢å°±ä¼šæ˜¾ç¤ºè¿‡æ—¶çš„ä¿¡æ¯ã€‚  
é€šè¿‡ä½¿ç”¨ setter å‡½æ•°ï¼Œæˆ‘ä»¬å‘Šè¯‰ React çŠ¶æ€å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦è¿›è¡Œé‡æ–°æ¸²æŸ“ï¼Œä»¥ä¾¿æ›´æ–°ç”¨æˆ·ç•Œé¢ã€‚

```js
function Counter() {
  const [count, setCount] = useState(0);

  function handleClick() {
    // This will error
    count = count + 1; // ğŸ”´ é”™è¯¯çš„ï¼šæ°¸è¿œä¸è¦ç›´æ¥ä¿®æ”¹ state
  }

  return (
    <button onClick={handleClick}>
      You pressed me {count} times
    </button>
  );
}
```

```js
function Counter() {
  const [count, setCount] = useState(0);

  function handleClick() {
    // This will right
    setCount(count + 1); // âœ… æ­£ç¡®çš„ï¼šä½¿ç”¨ç”± useState è¿”å›çš„ setter å‡½æ•°æ¥ä¿®æ”¹ stateã€‚
  }

  return (
    <button onClick={handleClick}>
      You pressed me {count} times
    </button>
  );
}
```
#### 6.8.3. ä¸è¦ä¿®æ”¹ Hook çš„è¿”å›å€¼å’Œå‚æ•°
<intro type="must" />

ä¸€æ—¦å€¼è¢«ä¼ é€’ç»™ Hookï¼Œå°±ä¸åº”è¯¥å†å¯¹å®ƒä»¬è¿›è¡Œä¿®æ”¹ã€‚å°±åƒåœ¨ JSX ä¸­çš„ props ä¸€æ ·ï¼Œå½“å€¼è¢«ä¼ é€’ç»™ Hook æ—¶ï¼Œå®ƒä»¬å°±åº”è¯¥æ˜¯ä¸å¯å˜çš„äº†ã€‚
```js
function useIconStyle(icon) {
  const theme = useContext(ThemeContext);
  if (icon.enabled) {
    // This will error
    icon.className = computeStyle(icon, theme); // ğŸ”´ é”™è¯¯çš„ï¼šæ°¸è¿œä¸è¦ç›´æ¥ä¿®æ”¹ Hook çš„å‚æ•°ã€‚
  }
  return icon;
}
```
```js
function useIconStyle(icon) {
  const theme = useContext(ThemeContext);
  const newIcon = { ...icon }; // âœ… æ­£ç¡®çš„ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‰¯æœ¬æ›¿ä»£
  if (icon.enabled) {
    // This will right
    newIcon.className = computeStyle(icon, theme);
  }
  return newIcon;
}
```

#### 6.8.4. ä¸è¦æ”¹å˜ä¼ é€’ç»™ JSX åçš„å€¼
ä¸è¦åœ¨ JSX ä½¿ç”¨è¿‡å€¼ä¹‹åæ”¹å˜å®ƒä»¬ã€‚åº”è¯¥åœ¨åˆ›å»º JSX ä¹‹å‰å®Œæˆå€¼çš„æ›´æ”¹ã€‚

å½“ä½ åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨ JSX æ—¶ï¼ŒReact å¯èƒ½ä¼šåœ¨ç»„ä»¶å®Œæˆæ¸²æŸ“ä¹‹å‰å°±æ€¥äºè®¡ç®— JSXã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœåœ¨å°†å€¼ä¼ é€’ç»™ JSX ä¹‹åå¯¹å®ƒä»¬è¿›è¡Œæ›´æ”¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´ UI è¿‡æ—¶ï¼Œå› ä¸º React ä¸ä¼šçŸ¥é“éœ€è¦æ›´æ–°ç»„ä»¶çš„è¾“å‡ºã€‚

```js
function Page({ colour }) {
  const styles = { colour, size: "large" };
  const header = <Header styles={styles} />;
  // This will error
  styles.size = "small"; // ğŸ”´ é”™è¯¯çš„ï¼šstyles å·²ç»åœ¨ä¸Šé¢çš„ JSX ä¸­ä½¿ç”¨äº†ã€‚
  const footer = <Footer styles={styles} />;
  return (
    <>
      {header}
      <Content />
      {footer}
    </>
  );
}
```

```js
function Page({ colour }) {
  const headerStyles = { colour, size: "large" };
  const header = <Header styles={headerStyles} />;
  // This will right
  const footerStyles = { colour, size: "small" }; // âœ… æ­£ç¡®çš„ï¼šæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å€¼ã€‚
  const footer = <Footer styles={footerStyles} />;
  return (
    <>
      {header}
      <Content />
      {footer}
    </>
  );
}
```

### 6.9. Hook çš„è§„åˆ™
Hook æ˜¯ä½¿ç”¨ JavaScript å‡½æ•°å®šä¹‰çš„ï¼Œä½†å®ƒä»¬ä»£è¡¨äº†ä¸€ç§ç‰¹æ®Šçš„å¯é‡ç”¨çš„ UI é€»è¾‘ï¼Œå¹¶ä¸”å¯¹å®ƒä»¬å¯ä»¥è¢«è°ƒç”¨çš„ä½ç½®æœ‰é™åˆ¶ã€‚

#### 6.9.1 åªåœ¨é¡¶å±‚è°ƒç”¨ Hook
<intro type="must" />

**ä¸è¦åœ¨å¾ªç¯ã€æ¡ä»¶è¯­å¥ã€åµŒå¥—å‡½æ•°æˆ– `try/catch/finally` ä»£ç å—ä¸­è°ƒç”¨ Hook**ã€‚ç›¸åï¼Œä½ åº”è¯¥åœ¨ React å‡½æ•°ç»„ä»¶çš„é¡¶å±‚ä½¿ç”¨ Hookï¼Œä¸”åœ¨ä»»ä½•æå‰è¿”å›ä¹‹å‰ã€‚ä½ åªèƒ½åœ¨ React æ¸²æŸ“å‡½æ•°ç»„ä»¶æ—¶è°ƒç”¨ Hookï¼š

* âœ… åœ¨ å‡½æ•°ç»„ä»¶ä¸»ä½“ çš„é¡¶å±‚è°ƒç”¨å®ƒä»¬ã€‚
* âœ… åœ¨ è‡ªå®šä¹‰ Hook ä¸»ä½“ çš„é¡¶å±‚è°ƒç”¨å®ƒä»¬ã€‚

```js
function Counter() {
  // âœ… æ­£ç¡®çš„ï¼šåœ¨å‡½æ•°ç»„ä»¶é¡¶å±‚
  // This will right
  const [count, setCount] = useState(0);
  // ...
}

function useWindowWidth() {
  // âœ… æ­£ç¡®çš„ï¼šåœ¨è‡ªå®šä¹‰ Hooks é¡¶å±‚
  // This will right
  const [width, setWidth] = useState(window.innerWidth);
  // ...
}
```

ä¸æ”¯æŒåœ¨å…¶ä»–ä»»ä½•æƒ…å†µä¸‹è°ƒç”¨ä»¥ `use` å¼€å¤´çš„ Hookï¼Œä¾‹å¦‚ï¼š

* ğŸ”´ ä¸è¦åœ¨æ¡ä»¶è¯­å¥æˆ–å¾ªç¯ä¸­è°ƒç”¨ Hookã€‚
* ğŸ”´ ä¸è¦åœ¨æ¡ä»¶æ€§çš„ `return` è¯­å¥ä¹‹åè°ƒç”¨ Hookã€‚
* ğŸ”´ ä¸è¦åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­è°ƒç”¨ Hookã€‚
* ğŸ”´ ä¸è¦åœ¨ç±»ç»„ä»¶ä¸­è°ƒç”¨ Hookã€‚
* ğŸ”´ ä¸è¦åœ¨ä¼ é€’ç»™ `useMemo`ã€`useReducer` æˆ– `useEffect` çš„å‡½æ•°å†…éƒ¨è°ƒç”¨ Hookã€‚
* ğŸ”´ ä¸è¦åœ¨ `try/catch/finally` ä»£ç å—ä¸­è°ƒç”¨ Hookã€‚

```js
function Bad({ cond }) {
  if (cond) {
    // ğŸ”´ é”™è¯¯çš„ï¼šåœ¨æ¡ä»¶è¯­å¥å†…éƒ¨ï¼ˆè¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œå°†å…¶ç§»åˆ°å¤–éƒ¨ï¼ï¼‰
    // This will error
    const theme = useContext(ThemeContext);
  }
  // ...
}

function Bad() {
  for (let i = 0; i < 10; i++) {
    // ğŸ”´ é”™è¯¯çš„ï¼šåœ¨å¾ªç¯è¯­å¥å†…éƒ¨ï¼ˆè¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œå°†å…¶ç§»åˆ°å¤–éƒ¨ï¼ï¼‰
    // This will error
    const theme = useContext(ThemeContext);
  }
  // ...
}

function Bad({ cond }) {
  if (cond) {
    return;
  }
  // ğŸ”´ é”™è¯¯çš„ï¼šåœ¨æ¡ä»¶æ€§ return è¯­å¥ä¹‹åï¼ˆè¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œå°†å…¶ç§»åˆ° return ä¹‹å‰ï¼ï¼‰
  // This will error
  const theme = useContext(ThemeContext);
  // ...
}

function Bad() {
  function handleClick() {
    // ğŸ”´ é”™è¯¯çš„ï¼šåœ¨äº‹ä»¶å¤„ç†å‡½æ•°å†…éƒ¨ï¼ˆè¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œå°†å…¶ç§»åˆ° return ä¹‹å‰ï¼ï¼‰
    // This will error
    const theme = useContext(ThemeContext);
  }
  // ...
}

function Bad() {
  const style = useMemo(() => {
    // ğŸ”´ é”™è¯¯çš„ï¼šåœ¨ useMemo å†…éƒ¨è°ƒç”¨ï¼ˆè¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œå°†å…¶ç§»åˆ°å¤–éƒ¨ï¼ï¼‰
    // This will error
    const theme = useContext(ThemeContext);
    return createStyle(theme);
  });
  // ...
}

class Bad extends React.Component {
  render() {
    // ğŸ”´ é”™è¯¯çš„ï¼šåœ¨ç±»ç»„ä»¶å†…éƒ¨è°ƒç”¨ï¼ˆè¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œæ”¹å†™ä¸ºå‡½æ•°ç»„ä»¶ï¼ï¼‰
    // This will error
    useEffect(() => {})
    // ...
  }
}

function Bad() {
  try {
    // ğŸ”´ é”™è¯¯çš„ï¼šåœ¨ tryã€catchã€finally ä»£ç å—å†…éƒ¨è°ƒç”¨ï¼ˆè¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œå°†å…¶ç§»åˆ°å¤–éƒ¨ï¼ï¼‰
    // This will error
    const [x, setX] = useState(0);
  } catch {
    const [x, setX] = useState(1);
  }
}
```
#### 6.9.2 ä»…åœ¨ React å‡½æ•°ä¸­è°ƒç”¨ Hook
<intro type="must" />

ä¸è¦åœ¨å¸¸è§„çš„ JavaScript å‡½æ•°ä¸­è°ƒç”¨ Hookã€‚ç›¸åï¼Œä½ å¯ä»¥ï¼š

* âœ… åœ¨ React å‡½æ•°ç»„ä»¶ä¸­è°ƒç”¨ Hookã€‚
* âœ… åœ¨ è‡ªå®šä¹‰ Hook ä¸­è°ƒç”¨ Hookã€‚

éµå¾ªè¿™æ¡è§„åˆ™ï¼Œä½ å¯ä»¥ç¡®ä¿ç»„ä»¶ä¸­çš„æ‰€æœ‰çŠ¶æ€é€»è¾‘åœ¨å…¶æºä»£ç ä¸­æ¸…æ™°å¯è§ã€‚


<maintainer authors={["hzm"]}/>

<comment/>

